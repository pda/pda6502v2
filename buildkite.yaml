steps:

  - label: ":rust: emu tests"
    command: >
      docker run
      --tty
      --env BUILDKITE_ANALYTICS_TOKEN="$$(buildkite-agent secret get ta_token_pda6502v2)"
      --env CI
      --env BUILDKITE_BUILD_ID
      --env BUILDKITE_BUILD_URL
      --env BUILDKITE_BRANCH
      --env BUILDKITE_COMMIT
      --env BUILDKITE_BUILD_NUMBER
      --env BUILDKITE_JOB_ID
      --env BUILDKITE_MESSAGE
      --volume "$$(pwd)/emu:/app"
      --workdir /app
      rustlang/rust:nightly
      sh -c "
      echo +++ :rust: cargo test;
      cargo test -- -Z unstable-options --format json --report-time | tee cargo-test.json;
      echo +++ :buildkite: test analytics;
      cargo install buildkite-test-collector;
      buildkite-test-collector < cargo-test.json;
      "
