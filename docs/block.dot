graph block {
  node [shape = box];

  6502 [label = "CPU\n6502"];

  // microcontroller
  subgraph cluster_a {
    style = invisible;
    SAMD21 [label = "Microcontroller\nSAMD21"];
    FLASH [label = "Flash\nstorage"];
    DISPLAY [label = "Display\nsysinfo"];
    USB [shape = oval];
    SAMD21 -- FLASH;
    SAMD21 -- DISPLAY;
    FLASH -- USB [style = invisible]; // push USB down
  }

	// bus groups
  {
    rank = same;
    node [style = dotted];
    BUS [label = "System Bus\nADDR[0..15]\nDATA[0..7]\nRWB"];
    CLK [label = "System Clock\n0 - 10 MHz"];
    IRQ [label = "Interrupt"];
    RESET [label = "Reset"];
  }

  ADEC [label = "ADDR\nDECODER\nCPLD"];

	// system bus devices
  {
    rank = same;
    SRAM;
		VIA [label = "6522\nVIA"];
		SPI [label = "SPI65/B\nCPLD"];
  }

  // IO ports
  {
    rank = same;
    node [shape = oval];
    GPIO [label = "GPIO\n2 x 8-bit"];
    SPI_PORT [label = "SPI x 4"];
  }

  ADEC -- SRAM [label = CS];
  ADEC -- VIA [label = CS];
  ADEC -- SPI [label = CS];

  6502 -- SAMD21 [label = BE];
  6502 -- SAMD21 [label = RDY];

  {
    VIA -- GPIO;
    SPI -- SPI_PORT [label = "SPI";];
    SPI_PORT -- SPI [label = "IRQ"; color = red;];
    SAMD21 -- USB;
  }

  {
    edge [color = blue];
    6502 -- BUS;
    SAMD21 -- BUS;
    BUS -- ADEC;
    BUS -- SPI;
    BUS -- SRAM;
    BUS -- VIA;
  }

  {
    edge [color = green];
    SAMD21 -- CLK;
    CLK -- 6502;
    CLK -- VIA;
    CLK -- SPI;
    CLK -- ADEC;
  }

  {
    edge [color = orange];
    SAMD21 -- RESET;
    RESET -- 6502;
    RESET -- SPI;
    RESET -- VIA;
    RESET -- ADEC;
  }

  {
    edge [color = red];
    6502 -- IRQ;
    IRQ -- VIA;
    IRQ -- SPI;
  }

}
